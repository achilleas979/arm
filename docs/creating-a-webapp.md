## Developing a simple Web Application using the OpenWeather API and SmartPhillips Hue plugins

In this task we will create a simple Web Client application that uses the previously developed ARM OpenWeather plugin and the available SmartPhillipsHue OSGi plugin.

1: Go to ARM_Core/tutorial/plugins/ folder and copy the SmartPhillipsHue OSGi plugin: SmartPhilipsHUELight_2.0.2.0.jar. Extract the hue.properties file from the resources folder in the JAR, edit the hue.properties file in Notepad++ and add the file back to the JAR. The properties file should include information on your Phillips Hue device.  

2: Paste it in the plugins folder of the ARM_Core project in Eclipse. Paste also the OpenWeather API plugin created in the previous task. The plugins should be now started as shown in the console. Go to e.g., PostMan again and type http://localhost:9050/services/ and click Send. You should get now:

```
Available OSGI:
1. OSGI Description: OpenWeather is an OSGi bundle for communicating with a OpenWeather API. This OSGi bundle implements two basic functionalities for interacting with the OpenWeather API: 	* GetWeatherByCityName	* GetWeatherByCityNameCountryCode
	Path for available methods: /services/OpenWeather
2. OSGI Description: SmartPhilipsHUELight is an OSGi bundle for communicating with a Philips HUE Light. This OSGi bundle implements four basic functionalities for interacting with the smart light: 	* Turn Light On	* Turn Light Off	* Dim Light	* Set Light Level
	Path for available methods: /services/SmartPhilipsHUELight
```
	
3:  In PostMan click on  /services/ SmartPhilipsHUELight and click Send. It will load the detailed documentation for the plugin. 

4:  We can now proceed with the Web Client development. In the Eclipse IDE go to File-> New-> Project and type Dynamic Web Project.  Select it, click Next and type the name OpenWeatherHueWebClient. Click New Runtime, select Apache Tomcat v.7.0, click Next, click Download and Install, click Finish, select the path to your eclipse folder e.g.,   C:\......\eclipse, wait for the installation to complete and when there are no errors click Finish. Make sure that Dynamic Module version is 3.0 in the wizard and click Finish.  Click No on the Windows that appears in Eclipse.

5:  Right click on the WebContent folder of the OpenWeatherHueWebClient project, go to New-> Folder and type libraries. Click Finish. Go to ARM_Core/tutorial/libraries/ folder and copy the jquery-3.2.0.min.js and WebClient.css and paste the two files in the libraries folder in Eclipse. 

6:  Right click on the libraries folder, go to New-> File and type WebClient.js. Click Finish. Spend some minutes to study the JavaScript code below. In short the code implements calls to the four RESTful services autogenerated for the 2 plugins: TurnLightOn, TurnLightOff, GetWeatherByCityName and GetWeatherByCityNameCountryCode. The very simple logic in the code is that if the temperature returned by the two weather APIs is >25 degrees then the light is turned on, otherwise its turned off. Copy and paste the following code in the WebClient.js file.     

``` JavaScript
// (Hardware Service) Actuator - SmartPhilipsHUELight ARM RESTful URL
var uriHue = "http://localhost:9050/services/SmartPhilipsHUELight/";
// (Software Service) Sensor - OpenWeather ARM RESTful URL
var uriOpenWeather = 'http://localhost:9050/services/OpenWeather/';

// SmartPhilipsHUELight
function TurnLightOn(resultElementId) {

    CallToARMHardwareSensor(resultElementId, "TurnLightOn", "Turn Light On");
}

function TurnLightOff(resultElementId) {

    CallToARMHardwareSensor(resultElementId, "TurnLightOff", "Turn Light Off");
}

//OpenWeather
function GetWeatherByCityName(resultElementId, CityNameInput) {

    var CityNameInputValue = document.getElementById(CityNameInput).value;

    if (CityNameInputValue == null || CityNameInputValue == "") {
        alert('Please enter the city name.');
        return;
    } else if (!isNaN(CityNameInputValue)) {
        alert('Please enter a name and not a number, e.g., London or Barcelona.');
        return;
    }

    CallToARMSoftwareSensor(resultElementId, "GetWeatherByCityName/" + CityNameInputValue, "GetWeatherByCityName");
}

function GetWeatherByCityNameCountryCode(resultElementId, CityNameInput, CountryCodeInput) {

    var CityNameInputValue = document.getElementById(CityNameInput).value;
    var CountryCodeInputValue = document.getElementById(CountryCodeInput).value;

    if (CityNameInputValue == null || CityNameInputValue == "") {
        alert('Please enter the city name.');
        return;
    } 
    else if (CountryCodeInputValue == null || CountryCodeInputValue == "") {
        alert('Please enter the country code.');
        return;
    }
    else if (!isNaN(CityNameInputValue)) {
        alert('Please enter a name and not a number, e.g., London or Barcelona.');
        return;
    } else if (!isNaN(CountryCodeInputValue)) {
        alert('Please enter a name and not a number, e.g., UK or CY or FR.');
        return;
    }

    CallToARMSoftwareSensor(resultElementId, "GetWeatherByCityNameCountryCode/" + CityNameInputValue + "/" + CountryCodeInputValue, "GetWeatherByCityNameCountryCode");
}

function CallToARMSoftwareSensor(resultElementId, methodName, logicalActionName) {
    var url = uriOpenWeather + methodName;

    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.send(null);
    xhr.onreadystatechange = function() {

        if (xhr.readyState == 4) {
            if (xhr.status == 200) {
                var responseTxt = xhr.responseText.replace(/\"/g, "");
                document.getElementById(resultElementId).innerHTML = responseTxt;
                if (responseTxt>25)
                    TurnLightOn('TurnLightOn');
                else
                    TurnLightOff('TurnLightOff');
                    
            } else {
                document.getElementById(resultElementId).innerHTML = 'Error ' + xhr.response;
            }
        }
    };
}

function CallToARMHardwareSensor(resultElementId, methodName, logicalActionName) {
    var url = uriHue + methodName;

    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.send(null);
    xhr.onreadystatechange = function() {

        if (xhr.readyState == 4) {
            var resultTxt = "";
            if (xhr.status == 200) {
                if (xhr.response == true || xhr.response == "true") {
                    resultTxt = 'Success ' + logicalActionName + '!';
                } else {
                    resultTxt = 'Error ' + logicalActionName + ': '
                            + xhr.status + ' - ' + xhr.statusText;
                }

            } else {
                var resultTxt = 'Error ' + logicalActionName + ': '
                        + xhr.status + ' - ' + xhr.statusText;
            }

            document.getElementById('HueLightResult').innerHTML = resultTxt;
        }
    };
}
```

7:  Right click on the WebContent folder, go to New-> HTML File and type WebClient.html. Click Finish. Spend some minutes to study the HTML code below. In short the code implements form input elements (e.g., text fields, buttons) that allow interacting with the JavaScript code and thus the ARM plugins for OpenWeather API and Phillips Hue light. 

To proceed copy and paste the following code in the WebClient.html file.     

```    
<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>WebClient</title>

<script type="text/javascript" src="libraries/jquery-3.2.0.min.js"></script>
<script type="text/javascript" src="libraries/WebClient.js"></script>
<link type="text/css" rel="stylesheet" href="libraries/WebClient.css" />

<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-12 col-md-12">
                <h1>WebClient - SmartPhilipsHUELight && OpenWeather</h1>
 <h1>PLEASE TURN OFF THE LAMP WHEN YOU ARE DONE!!!</h1>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-md-12">
                <p class="text-muted">WebClient for interacting with SmartPhilipsHUELight && OpenWeather.</p>
                <p class="text-muted">This simple web app allows calling OpenWeather ARM plugin REST API and 
                if the city temperature returned is >25celsius it turns on the Hue light else turns it off.</p>
            </div>
        </div>
        <div class="row">
        <div class="col-xs-12 col-md-6">
                <div class="panel panel-info">
                    <div class="panel-heading">
                        <h2 class="panel-title">1. GetWeatherByCityName</h2>
                    </div>
                    <div class="panel-body">
                        <p>
                            <i>Description:</i> Invoking OpenWeather API by City Name will return the temp in Celsius.
                        </p>
                        <span>City Name: </span> 
                        <input type="text" id="GetWeatherByCityNameInput" value="" style="width: 100px; height: 25px" /> <br /> 
                        <br />
                        <button type="button" id="GetWeatherByCityNameBtn" name="GetWeatherByCityName"
                            onclick="Javascript:GetWeatherByCityName('GetWeatherByCityNameResult', 'GetWeatherByCityNameInput')"
                            class="btn btn-primary" role="button">GetWeatherByCityName</button>
                    </div>
                    <div class="panel-footer">
                        <label><i>Result: </i></label> <span id="GetWeatherByCityNameResult"></span>
                    </div>
                </div>
            </div>
        
        <div class="col-xs-12 col-md-6">
                <div class="panel panel-info">
                    <div class="panel-heading">
                        <h2 class="panel-title">2. GetWeatherByCityNameCountryCode</h2>
                    </div>
                    <div class="panel-body">
                        <p>
                            <i>Description:</i> Invoking OpenWeather API by City Name will return the temp in Celsius.
                        </p>
                        <span>CityName, e.g., London: </span> 
                        <input type="text" id="CityNameInput" value="" style="width: 100px; height: 25px" /> <br /> <br />
                        <span>CountryCode, e.g., UK: </span> 
                        <input type="text" id="CountryCodeInput" value="" style="width: 50px; height: 25px" /> <br /> <br />
                        <button type="button" id="GetWeatherByCityNameCountryCodeBtn" name="GetWeatherByCityNameCountryCode"
                            onclick="Javascript:GetWeatherByCityNameCountryCode('GetWeatherByCityNameCountryCodeResult', 'CityNameInput', 'CountryCodeInput')"
                            class="btn btn-primary" role="button">GetWeatherByCityNameCountryCode</button>
                    </div>
                    <div class="panel-footer">
                        <label><i>Result: </i></label> <span id="GetWeatherByCityNameCountryCodeResult"></span>
                    </div>
                </div>
            </div>
    </div>
</body>
</html>
```

8:  Right click on WebClient.html, go to Run As-> Run on Server, make sure Apache Tomcat Server 7.0 is selected & click Finish. Copy http://localhost:8080/OpenWeatherHueWebClient/WebClient.html and open it in Chrome for optimal experience. You should see a WebClient UI similar to the below:
![WebClient App Image](https://github.com/achilleas979/arm/blob/master/images/webapp.png)

Type in the first panel London and click the GetWeatherByCityName button, which should cause the light to turn on if current temperature is >25 degrees. If not try another city name. Type in the second panel Oslo and NO in the text fields and click the GetWeatherByCityNameCountryCode button, which should cause the light to turn off if current temperature is <25 degrees. If not try another city name and country code.

Congratulation you have completed and loaded your first Web Client application that uses ARM-specific Java OSGi plugins. 

